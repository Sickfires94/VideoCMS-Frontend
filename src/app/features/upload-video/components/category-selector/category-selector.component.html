<!-- VIEW: Renders category search and selection UI. Binds to ViewModel properties and commands. -->
<div class="p-4 bg-white rounded-lg shadow-md mb-4">
  <label for="categorySearch" class="block text-lg font-semibold text-gray-700 mb-2">Select Category</label>

  <div class="relative">
    <input
      id="categorySearch"
      type="text"
      [formControl]="categorySearchControl"
      placeholder="Search for a category..."
      (focus)="onBlur()"
      (blur)="onBlur()"
      [ngClass]="{
        'border-green-500 bg-green-50 text-green-800 font-semibold': selectedCategory,
        'border-gray-300': !selectedCategory
      }"
      class="w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
    /> <!-- FIX: Properly self-closed the input tag here -->
    <!-- REMOVED: [readonly]="!!selectedCategory" to allow editing -->
    <!-- Add a clear button directly in the input if a category is selected -->
    <button
      *ngIf="selectedCategory"
      type="button"
      (click)="clearCategory()"
      class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
      title="Clear selected category"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>


    <div *ngIf="isLoadingResults" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
      <app-loading-spinner size="small"></app-loading-spinner>
    </div>

    <ul *ngIf="searchResults.length > 0 && categorySearchControl.value && !selectedCategory"
        class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
      <li *ngFor="let category of searchResults"
          (mousedown)="selectCategory(category)" class="px-3 py-2 cursor-pointer hover:bg-gray-100 text-gray-800 rounded-md transition duration-150 ease-in-out">
        {{ category.categoryName }} <!-- Use categoryName -->
      </li>
    </ul>

    <!-- NEW: Option to create new category -->
    <div *ngIf="showCreateOption" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1">
      <button
        type="button"
        (click)="onCreateNewCategory()"
        class="w-full px-3 py-2 text-left text-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out rounded-md"
      >
        Create new category: "<span class="font-semibold">{{ categorySearchControl.value }}</span>"
      </button>
    </div>

    <!-- REMOVED: "No categories found" message -->
  </div>

  <!-- REMOVED: This block previously displayed the selected category below the input field -->
</div>